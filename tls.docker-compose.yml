# Generated by setupmc.com
services:
  mc:
    image: itzg/minecraft-server:stable-java21-jdk
    tty: true
    stdin_open: true
    environment:
      EULA: "TRUE"
      TYPE: "MODRINTH"
      VERSION: "1.21.1"
      ONLINE_MODE: "false"
      MODRINTH_MODPACK: "5FFgwNNP" # CobbleMon
      MODRINTH_VERSION: "1.7.1"
      MEMORY: "8192M"
      MOTD: "CobbleMon server for Container Intro"
      ICON: "https://cdn.modrinth.com/data/5FFgwNNP/e7f9ee2e9d361623847853fe2ddce42f519ee64f.png"
      USE_AIKAR_FLAGS: "true"
      USE_MEOWICE_FLAGS: "true"
      TZ: "Europe/Rome"
      DIFFICULTY: "2"
      LEVEL: "devops"
      REGION_FILE_COMPRESSION: "lz4"
      MAX_PLAYERS: "30"
      OPS: |-
        kymai
      ENABLE_WHITELIST: "false"
      MODRINTH_PROJECTS: |-
        fRQREgAc:cQ5fH43X # Dynmap 3.7-beta-8 for Fabric v1.21.1
      MODRINTH_DOWNLOAD_DEPENDENCIES: "required"
      ENFORCE_SECURE_PROFILE: "false"
      ALLOW_FLIGHT: "true"
    volumes:
      - "mc-data:/data"

    networks:
      - traefik-net
    # ports: # - "8123:8123"
    labels:
      - "traefik.enable=true"
      - "traefik.tcp.routers.mc-tcp.entrypoints=minecraft"
      - "traefik.tcp.routers.mc-tcp.rule=HostSNI(`*`)"
      - "traefik.tcp.services.mc-tcp.loadbalancer.server.port=25565"
      - "traefik.http.routers.mc-web.entrypoints=websecure"
      - "traefik.http.routers.mc-web.rule=Host(`containermon.duckdns.org`)"
      - "traefik.http.routers.mc-web.tls=true"
      - "traefik.http.routers.mc-web.tls.certresolver=duckdns"
      - "traefik.http.routers.mc-web-local.entrypoints=websecure"
      - "traefik.http.routers.mc-web-local.rule=Host(`localhost`)"
      - "traefik.http.routers.mc-web-local.tls=true"
      - "traefik.http.routers.mc-web-local.service=mc-web"
      - "traefik.http.routers.mc-web-http.entrypoints=web"
      - "traefik.http.routers.mc-web-http.rule=Host(`containermon.duckdns.org`) || Host(`localhost`)"
      - "traefik.http.routers.mc-web-http.service=mc-web"
      - "traefik.http.services.mc-web.loadbalancer.server.port=8123"

  # 2. IL REVERSE PROXY (Traefik)
  traefik:
    image: traefik:v3.6.7
    container_name: traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--entrypoints.minecraft.address=:25565"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.websecure.asDefault=true"
      - "--serversTransport.insecureSkipVerify=true" #Comment out once working
      - "--providers.docker.endpoint=unix:///var/run/docker.sock"
      - "--providers.docker.exposedByDefault=false"
      - "--certificatesresolvers.duckdns.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.duckdns.acme.storage=/letsencrypt/acme.json" #sudo touch acme.json && sudo chmod 600 acme.json
      - "--certificatesresolvers.duckdns.acme.caServer=https://acme-staging-v02.api.letsencrypt.org/directory" #Staging to avoid rate limiting, comment out for production
      - "--certificatesresolvers.duckdns.acme.dnschallenge.disablepropagationcheck=true"
      - "--certificatesresolvers.duckdns.acme.dnschallenge.provider=duckdns"
      - "--certificatesresolvers.duckdns.acme.dnschallenge.delaybeforecheck=600"
      - "--certificatesresolvers.duckdns.acme.dnschallenge.resolvers=1.1.1.1:53,1.0.0.1:53"
    environment:
      - DUCKDNS_TOKEN=${DUCKDNS_TOKEN}
    ports:
      - "25565:25565"
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - "./letsencrypt:/letsencrypt"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    networks:
      - traefik-net
  # 3. DYNAMIC DNS UPDATER (DuckDNS)
  # duckdns:
  #   image: lscr.io/linuxserver/duckdns:version-72c8259f
  #   container_name: duckdns
  #   environment:
  #     - SUBDOMAINS=containermon,containermon
  #     - TOKEN=${DUCKDNS_TOKEN}
  #     - LOG_FILE=false
  #   restart: unless-stopped

networks:
  traefik-net:
    driver: bridge

volumes:
  mc-data:
